name: Filter CDN Rules

on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯ 7 å¤©çš„ UTC 00:00ï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
  schedule:
    - cron: "0 0 */7 * *"

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # å¯é€‰ï¼šå½“ filter_cdn.py è¢«ä¿®æ”¹æ—¶ä¹Ÿè§¦å‘
  push:
    paths:
      - "auto/filter_cdn.py"
      - ".github/workflows/filter-cdn.yml"

jobs:
  filter-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…éœ€ï¼šå…è®¸æäº¤ä»£ç 

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. è®¾ç½® Python çŽ¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # 4. æ‰§è¡Œç­›é€‰è„šæœ¬
      - name: Run filter script
        id: run_script
        run: |
          cd auto
          python filter_cdn.py
        continue-on-error: false # è„šæœ¬å¤±è´¥åˆ™åœæ­¢

      # 5. æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
      - name: Check for changes
        id: check_changes
        run: |
          git add rules/
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

      # 6. æäº¤å˜åŒ–ï¼ˆå¦‚æžœæœ‰ï¼‰
      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # èŽ·å–ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¦‚æžœæœ‰ï¼‰
          STATS=$(grep -E "ç­›é€‰åŽè§„åˆ™æ•°|è¦†ç›–çŽ‡|å¤„ç†è€—æ—¶" auto/../*.log 2>/dev/null | head -3 || echo "")

          git commit -m "chore: update CDN rules [skip ci]

          Auto-generated by GitHub Actions
          $STATS"

          git push

      # 7. ä¸Šä¼ ç”Ÿæˆçš„æ–‡ä»¶ä½œä¸º artifact
      - name: Upload rules as artifact
        if: always() # å³ä½¿å‰é¢æ­¥éª¤å¤±è´¥ä¹Ÿä¸Šä¼ 
        uses: actions/upload-artifact@v4
        with:
          name: cdn-rules-${{ github.run_number }}
          path: rules/*.list
          retention-days: 30
          if-no-files-found: warn

      # 8. è¾“å‡ºæ‰§è¡Œæ‘˜è¦
      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ“Š æ‰§è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f rules/*.list ]; then
            echo "âœ… è§„åˆ™æ–‡ä»¶å·²ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ç”Ÿæˆçš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
            ls -lh rules/*.list | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ æœªæ‰¾åˆ°ç”Ÿæˆçš„è§„åˆ™æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ‰§è¡Œæ—¶é—´" >> $GITHUB_STEP_SUMMARY
          echo "- å¼€å§‹æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
