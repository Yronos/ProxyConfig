name: Compile Local Rules (On Change)

on:
  push:
    paths:
      - "rules/sing-box/*.json" # ä»…ç›‘å¬æ ¹ç›®å½• JSON æ–‡ä»¶
      - ".github/workflows/compile-local-sing-box-rules.yml" # å·¥ä½œæµè‡ªèº«å˜æ›´
  workflow_dispatch:

permissions:
  contents: write

env:
  SING_BOX_VERSION: 1.12.20
  LOCAL_SOURCE_DIR: rules/sing-box
  LOCAL_COMPILED_DIR: rules/sing-box/local

jobs:
  compile_local:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install sing-box
        uses: actions/cache@v3
        id: cache-singbox
        with:
          path: /usr/local/bin/sing-box
          key: sing-box-${{ env.SING_BOX_VERSION }}

      - name: Download sing-box
        if: steps.cache-singbox.outputs.cache-hit != 'true'
        run: |
          curl -Lo sing-box.tar.gz https://github.com/SagerNet/sing-box/releases/download/v${SING_BOX_VERSION}/sing-box-${SING_BOX_VERSION}-linux-amd64.tar.gz
          tar -xzf sing-box.tar.gz
          chmod +x sing-box-${SING_BOX_VERSION}-linux-amd64/sing-box
          sudo mv sing-box-${SING_BOX_VERSION}-linux-amd64/sing-box /usr/local/bin/sing-box

      - name: Verify sing-box installation
        run: sing-box version

      - name: Detect changed JSON files
        id: changed-files
        run: |
          # èŽ·å–æœ¬æ¬¡æäº¤ä¸­å˜æ›´çš„ JSON æ–‡ä»¶
          CHANGED_JSON=$(git diff --name-only HEAD~1 HEAD | grep "^${LOCAL_SOURCE_DIR}/[^/]*\.json$" || true)

          if [ -z "${CHANGED_JSON}" ]; then
            echo "â„¹ï¸  No JSON files changed in this commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“ Changed JSON files:"
            echo "${CHANGED_JSON}"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "${CHANGED_JSON}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Prepare local compiled directory
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          mkdir -p ${LOCAL_COMPILED_DIR}
          echo "âœ… Local compiled directory ready"

      - name: Compile changed local rules
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          cd ${LOCAL_SOURCE_DIR}

          COMPILED=0
          FAILED=0
          FAILED_FILES=""

          # ä½¿ç”¨æ–‡ä»¶è®°å½•ç»Ÿè®¡ä¿¡æ¯ï¼ˆé¿å…å˜é‡ä½œç”¨åŸŸé—®é¢˜ï¼‰
          echo "0" > /tmp/compiled_count
          echo "0" > /tmp/failed_count

          # ä»…ç¼–è¯‘å˜æ›´çš„æ–‡ä»¶
          while IFS= read -r json_path; do
            [ -z "${json_path}" ] && continue

            json_file=$(basename "${json_path}")

            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä»ç„¶å­˜åœ¨ï¼ˆå¯èƒ½è¢«åˆ é™¤ï¼‰
            if [ ! -f "${json_file}" ]; then
              echo "âš ï¸  File deleted: ${json_file}"
              # åˆ é™¤å¯¹åº”çš„ .srs æ–‡ä»¶
              srs_file="${LOCAL_COMPILED_DIR}/$(basename ${json_file} .json).srs"
              if [ -f "${srs_file}" ]; then
                rm -f "${srs_file}"
                echo "  ðŸ—‘ï¸  Removed: ${srs_file}"
              fi
              continue
            fi

            echo "Compiling: ${json_file} -> local/$(basename ${json_file} .json).srs"

            if sing-box rule-set compile --output "${LOCAL_COMPILED_DIR}/$(basename ${json_file} .json).srs" "${json_file}"; then
              COMPILED=$(cat /tmp/compiled_count)
              COMPILED=$((COMPILED + 1))
              echo "${COMPILED}" > /tmp/compiled_count
              echo "  âœ… Success"
            else
              echo "  âŒ Failed: ${json_file}"
              FAILED=$(cat /tmp/failed_count)
              FAILED=$((FAILED + 1))
              echo "${FAILED}" > /tmp/failed_count
              FAILED_FILES="${FAILED_FILES}\n- ${json_file}"
            fi
          done <<< "${{ steps.changed-files.outputs.changed_files }}"

          # è¯»å–æœ€ç»ˆç»Ÿè®¡
          FINAL_COMPILED=$(cat /tmp/compiled_count)
          FINAL_FAILED=$(cat /tmp/failed_count)

          echo "âœ… Compilation completed:"
          echo "   - Compiled: ${FINAL_COMPILED}"
          echo "   - Failed: ${FINAL_FAILED}"

          if [ ${FINAL_FAILED} -gt 0 ]; then
            echo "::warning::Failed to compile some files:${FAILED_FILES}"
          fi

      # ========== ðŸ”¥ å…³é”®æ­¥éª¤ï¼šæäº¤ç¼–è¯‘ç»“æžœ ==========
      - name: Commit and push local rules
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          git add ${LOCAL_COMPILED_DIR}

          if git diff-index --quiet HEAD --; then
            echo "âœ… No compilation output changes"
            exit 0
          fi

          # èŽ·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          COMPILED_FILES=$(git diff --cached --name-only | grep "\.srs$" | sed 's|^.*/||' | sed 's|\.srs$||' || echo "")

          if [ -z "${COMPILED_FILES}" ]; then
            # å¯èƒ½åªæ˜¯åˆ é™¤äº†æ–‡ä»¶
            DELETED_FILES=$(git diff --cached --name-only --diff-filter=D | grep "\.srs$" | sed 's|^.*/||' | sed 's|\.srs$||' || echo "")
            if [ -n "${DELETED_FILES}" ]; then
              FILE_COUNT=$(echo "${DELETED_FILES}" | wc -l)
              COMMIT_MSG="chore(local): remove ${FILE_COUNT} obsolete rule(s)"
              COMMIT_BODY="Removed rules:"
              while IFS= read -r file; do
                COMMIT_BODY="${COMMIT_BODY}\n- ${file}"
              done <<< "${DELETED_FILES}"
            else
              echo "âœ… No changes to commit"
              exit 0
            fi
          else
            FILE_COUNT=$(echo "${COMPILED_FILES}" | wc -l | tr -d ' ')
            COMMIT_MSG="chore(local): compile ${FILE_COUNT} rule(s)"
            COMMIT_BODY="Updated rules:"
            while IFS= read -r file; do
              COMMIT_BODY="${COMMIT_BODY}\n- ${file}"
            done <<< "${COMPILED_FILES}"
          fi

          COMMIT_BODY="${COMMIT_BODY}\n\nCompiled with sing-box v${SING_BOX_VERSION}"

          git commit -m "${COMMIT_MSG}" -m "${COMMIT_BODY}"

          # æŽ¨é€ï¼ˆå¸¦é‡è¯•ï¼‰
          for i in {1..3}; do
            if git push; then
              echo "âœ… Push successful"
              exit 0
            else
              echo "âš ï¸  Push failed, retrying ($i/3)..."
              sleep 2
              git pull --rebase
            fi
          done

          echo "âŒ Push failed after 3 attempts"
          exit 1

      # ========== å¯é€‰ï¼šç”Ÿæˆæ‰§è¡Œæ‘˜è¦ ==========
      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ“Š Local Rules Compilation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: Code push" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Compiler**: sing-box v${SING_BOX_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.changed-files.outputs.has_changes }}" == "true" ]; then
            echo "### Changed Files" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.changed-files.outputs.changed_files }}" | while IFS= read -r file; do
              [ -z "${file}" ] && continue
              echo "- \`${file}\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "â„¹ï¸ No JSON files changed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "${LOCAL_COMPILED_DIR}" ]; then
            SRS_COUNT=$(find ${LOCAL_COMPILED_DIR} -name "*.srs" 2>/dev/null | wc -l)
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Total Compiled Rules: ${SRS_COUNT}" >> $GITHUB_STEP_SUMMARY
          fi
