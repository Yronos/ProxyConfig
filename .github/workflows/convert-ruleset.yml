# .github/workflows/convert-ruleset.yml
name: Convert Domain-Set to Rule-Set

on:
  schedule:
    - cron: "0 18 * * *" # UTC æ¯å¤© 18:00 = åŒ—äº¬æ¬¡æ—¥ 02:00
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - "auto/convert_ruleset.py"

jobs:
  convert-rules:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests urllib3

      - name: ğŸ—‚ï¸ Ensure directories exist
        run: |
          mkdir -p auto/rule-set
          echo "âœ… Directories created"
          ls -la auto/

      - name: ğŸ”„ Run convert_ruleset.py
        id: run_convert
        run: |
          cd auto
          python convert_ruleset.py
          exit_code=$?
          if [ $exit_code -ne 0 ]; then
            echo "âŒ Script failed with exit code $exit_code"
            exit $exit_code
          fi
          echo "âœ… Conversion completed successfully"

      - name: âœ… Verify output
        id: verify
        run: |
          if [ ! -d "auto/rule-set" ]; then
            echo "âŒ Directory auto/rule-set not found"
            exit 1
          fi

          # æŸ¥æ‰¾æ‰€æœ‰è½¬æ¢åçš„æ–‡ä»¶
          file_count=$(find auto/rule-set -type f \( -name "*.list" -o -name "*.conf" \) | wc -l)

          if [ "$file_count" -eq 0 ]; then
            echo "âš ï¸ No rule files generated"
            echo "file_count=0" >> $GITHUB_OUTPUT
          else
            echo "âœ… Generated $file_count rule files"
            echo "file_count=$file_count" >> $GITHUB_OUTPUT
          fi

          # è®¡ç®—æ€»å¤§å°
          total_size=$(du -sh auto/rule-set 2>/dev/null | cut -f1 || echo "0")
          echo "total_size=$total_size" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Show file structure
        run: |
          echo "ğŸ“‹ Rule-Set directory structure:"
          echo "-----------------------------------"
          if command -v tree &> /dev/null; then
            tree -h auto/rule-set/ 2>/dev/null || echo "Directory empty or not found"
          else
            find auto/rule-set -type f -exec sh -c 'echo "  ğŸ“„ {} ($(wc -l < {} | tr -d " ") lines)"' \; 2>/dev/null || echo "No files found"
          fi

      - name: ğŸ’¾ Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "ğŸ“‚ Git status:"
          git status

          # æ·»åŠ æ–‡ä»¶
          git add -f auto/rule-set/ 2>/dev/null || true

          echo ""
          echo "ğŸ“‚ Files to be committed:"
          git diff --cached --name-only || echo "No files staged"

          if ! git diff --cached --quiet; then
            changed_files=$(git diff --cached --name-only | wc -l)

            git commit -m "ğŸ”„ Auto-update: Convert rule-set files

          ğŸ“… Generated: $(date +'%Y-%m-%d %H:%M:%S UTC')
          ğŸ“Š Files: ${{ steps.verify.outputs.file_count }}
          ğŸ“¦ Size: ${{ steps.verify.outputs.total_size }}

          ğŸ”„ Workflow: ${{ github.workflow }}
          ğŸƒ Run: #${{ github.run_number }}"

            echo "ğŸš€ Pushing to repository..."
            git push origin main

            echo "âœ… Successfully committed ${changed_files} files!"
          else
            echo "ğŸ“Œ No changes detected, skipping commit"
          fi

      - name: ğŸ“¤ Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: converted-rules-${{ github.run_number }}
          path: auto/rule-set/**
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸ“ Generate summary
        if: always()
        run: |
          {
            echo "## ğŸ”„ Rule-Set Conversion Results"
            echo ""
            echo "### ğŸ“Š Statistics"
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| Files Generated | **${{ steps.verify.outputs.file_count }}** |"
            echo "| Total Size | **${{ steps.verify.outputs.total_size }}** |"
            echo "| Execution Time | $(date +'%Y-%m-%d %H:%M:%S UTC') |"
            echo ""
            echo "### ğŸ“ Generated Files"
            echo "\`\`\`"
            find auto/rule-set -type f -exec sh -c 'echo "ğŸ“„ {} - $(wc -l < {}) lines"' \; 2>/dev/null || echo "No files found"
            echo "\`\`\`"
          } >> $GITHUB_STEP_SUMMARY
