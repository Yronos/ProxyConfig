name: Filter Country Domain Rules

on:
  schedule:
    - cron: "0 2 */3 * *"
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "auto/**"

jobs:
  filter-rules:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ðŸ“¦ Install dependencies
        run: pip install requests urllib3

      - name: ðŸ—‚ï¸ Ensure directories exist
        run: |
          mkdir -p auto/new
          mkdir -p auto/original
          ls -la auto/

      - name: ðŸš€ Run filter_countries.py
        run: |
          cd auto
          python filter_countries.py

      - name: âœ… Verify output
        id: verify
        run: |
          if [ ! -d "auto/new" ]; then
            echo "âŒ Directory auto/new not found"
            exit 1
          fi

          file_count=$(find auto/new -name "*.list" -type f | wc -l)
          if [ "$file_count" -eq 0 ]; then
            echo "âŒ No .list files generated"
            exit 1
          fi

          echo "âœ… Generated $file_count rule files:"
          ls -lh auto/new/
          echo "file_count=$file_count" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Show file contents preview
        run: |
          echo "ðŸ“‹ File preview:"
          for file in auto/new/*.list; do
            if [ -f "$file" ]; then
              echo "---"
              echo "File: $file"
              echo "Lines: $(wc -l < "$file")"
              echo "Size: $(du -h "$file" | cut -f1)"
            fi
          done

      - name: ðŸ’¾ Commit and push ALL files
        run: |
          # é…ç½® Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ˜¾ç¤ºå½“å‰çŠ¶æ€
          echo "ðŸ“‚ Current git status:"
          git status

          # å¼ºåˆ¶æ·»åŠ æ‰€æœ‰æ–‡ä»¶ï¼ˆå¿½ç•¥ .gitignoreï¼‰
          git add -f auto/new/*.list
          git add -f auto/original/*.list

          # å†æ¬¡æ£€æŸ¥çŠ¶æ€
          echo "ðŸ“‚ After adding files:"
          git status

          # å¦‚æžœæœ‰å˜åŒ–å°±æäº¤
          if ! git diff --cached --quiet; then
            # åˆ›å»ºè¯¦ç»†çš„æäº¤ä¿¡æ¯
            commit_msg="ðŸ¤– Auto-update: Filter domain rules

          ðŸ“… Generated: $(date +'%Y-%m-%d %H:%M:%S UTC')
          ðŸ“Š Files: ${{ steps.verify.outputs.file_count }} rule files
          ðŸ”„ Workflow: ${{ github.workflow }}
          ðŸƒ Run: #${{ github.run_number }}

          Files updated:
          $(git diff --cached --name-only | sed 's/^/- /')"

            echo "ðŸ’¾ Committing changes..."
            git commit -m "$commit_msg"

            echo "ðŸš€ Pushing to repository..."
            git push

            echo "âœ… Successfully committed and pushed!"
          else
            echo "ðŸ“Œ No changes detected"
          fi

      - name: ðŸ“¤ Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: filtered-rules-${{ github.run_number }}
          path: |
            auto/new/*.list
            auto/original/*.list
          retention-days: 30

      - name: ðŸ“ Generate summary
        if: always()
        run: |
          {
            echo "## ðŸŽ¯ Execution Results"
            echo ""
            echo "### ðŸ“Š Statistics"
            echo "- **Files Generated**: ${{ steps.verify.outputs.file_count }}"
            echo "- **Execution Time**: $(date +'%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "### ðŸ“ Generated Files"
            echo "\`\`\`"
            ls -lh auto/new/ 2>/dev/null || echo "No files"
            echo "\`\`\`"
          } >> $GITHUB_STEP_SUMMARY
