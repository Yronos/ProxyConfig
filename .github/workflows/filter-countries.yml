name: Filter Country Domain Rules

on:
  schedule:
    - cron: "0 2 * * 0" # UTC å‘¨æ—¥ 02:00 = åŒ—äº¬å‘¨æ—¥ 10:00
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "auto/filter_countries.py"

jobs:
  filter-rules:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ðŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests urllib3

      - name: ðŸ—‚ï¸ Ensure base directories exist
        run: |
          mkdir -p rules
          echo "âœ… Base directory created"
          ls -la

      - name: ðŸš€ Run filter_countries.py
        id: run_script
        run: |
          cd auto
          python filter_countries.py
          exit_code=$?
          if [ $exit_code -ne 0 ]; then
            echo "âŒ Script failed with exit code $exit_code"
            exit $exit_code
          fi
          echo "âœ… Script completed successfully"

      - name: âœ… Verify output
        id: verify
        run: |
          if [ ! -d "rules" ]; then
            echo "âŒ Directory rules/ not found"
            exit 1
          fi

          # é€’å½’æŸ¥æ‰¾æ‰€æœ‰.listæ–‡ä»¶ï¼ˆæŽ’é™¤ original å­ç›®å½•ï¼‰
          file_count=$(find rules -name "*.list" -type f ! -path "*/original/*" | wc -l)

          if [ "$file_count" -eq 0 ]; then
            echo "âŒ No .list files generated"
            echo "ðŸ“‚ Directory structure:"
            tree rules/ || ls -lR rules/
            exit 1
          fi

          echo "âœ… Generated $file_count rule files"
          echo "file_count=$file_count" >> $GITHUB_OUTPUT

          # ç»Ÿè®¡å„ç±»åž‹è§„åˆ™æ•°é‡
          mihomo_count=$(find rules/mihomo -name "*.list" -type f ! -path "*/original/*" 2>/dev/null | wc -l)
          surge_count=$(find rules/surge -name "*.list" -type f ! -path "*/original/*" 2>/dev/null | wc -l)
          loon_count=$(find rules/loon -name "*.list" -type f ! -path "*/original/*" 2>/dev/null | wc -l)
          non_ip_count=$(find rules/non_ip -name "*.list" -type f 2>/dev/null | wc -l)

          echo "mihomo_count=$mihomo_count" >> $GITHUB_OUTPUT
          echo "surge_count=$surge_count" >> $GITHUB_OUTPUT
          echo "loon_count=$loon_count" >> $GITHUB_OUTPUT
          echo "non_ip_count=$non_ip_count" >> $GITHUB_OUTPUT

          # è®¡ç®—æ€»å¤§å°
          total_size=$(du -sh rules | cut -f1)
          echo "total_size=$total_size" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Show detailed file structure
        run: |
          echo "ðŸ“‹ Complete directory structure:"
          echo "-----------------------------------"

          if command -v tree &> /dev/null; then
            tree -h rules/
          else
            echo "ðŸ“‚ rules/"
            for rule_type in mihomo surge loon non_ip; do
              if [ -d "rules/$rule_type" ]; then
                echo ""
                echo "  ðŸ“‚ $rule_type/"

                # æ˜¾ç¤º original ç›®å½•ï¼ˆnon_ip é™¤å¤–ï¼‰
                if [ "$rule_type" != "non_ip" ] && [ -d "rules/$rule_type/original" ]; then
                  echo "    ðŸ“‚ original/"
                  find "rules/$rule_type/original" -type f -name "*.list" -exec sh -c 'echo "      â”œâ”€ $(basename {}) ($(wc -l < {} | tr -d " ") lines)"' \;
                fi

                # æ˜¾ç¤ºå¤„ç†åŽçš„æ–‡ä»¶
                echo "    ðŸ“„ Processed files:"
                find "rules/$rule_type" -maxdepth 1 -type f -name "*.list" -exec sh -c 'echo "      â”œâ”€ $(basename {}) ($(wc -l < {} | tr -d " ") lines, $(du -h {} | cut -f1))"' \;
              fi
            done
          fi

      - name: ðŸ’¾ Commit and push changes
        run: |
          # é…ç½® Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ˜¾ç¤ºå½“å‰çŠ¶æ€
          echo "ðŸ“‚ Git status before adding files:"
          git status

          # æ·»åŠ  rules ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
          git add -f rules/

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«æ·»åŠ 
          echo ""
          echo "ðŸ“‚ Files to be committed:"
          git diff --cached --name-only || echo "No files staged"

          # å¦‚æžœæœ‰å˜åŒ–å°±æäº¤
          if ! git diff --cached --quiet; then
            # èŽ·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
            changed_files=$(git diff --cached --name-only | wc -l)

            # åˆ›å»ºæäº¤ä¿¡æ¯
            cat > /tmp/commit_msg.txt << EOF
          ðŸ¤– Auto-update: Filter domain rules

          ðŸ“… Generated: $(date +'%Y-%m-%d %H:%M:%S UTC')
          ðŸ“Š Statistics:
             â€¢ Total files: ${{ steps.verify.outputs.file_count }}
             â€¢ Mihomo: ${{ steps.verify.outputs.mihomo_count }}
             â€¢ Surge: ${{ steps.verify.outputs.surge_count }}
             â€¢ Loon: ${{ steps.verify.outputs.loon_count }}
             â€¢ Non-IP: ${{ steps.verify.outputs.non_ip_count }}
             â€¢ Total size: ${{ steps.verify.outputs.total_size }}
             â€¢ Changed files: ${changed_files}

          ðŸ”„ Workflow: ${{ github.workflow }}
          ðŸƒ Run: #${{ github.run_number }}
          ðŸ”— Link: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF

            echo "ðŸ’¾ Committing changes..."
            git commit -F /tmp/commit_msg.txt

            echo "ðŸš€ Pushing to repository..."
            git push origin main

            echo "âœ… Successfully committed and pushed ${changed_files} files!"
          else
            echo "ðŸ“Œ No changes detected, skipping commit"
          fi

      - name: ðŸ“¤ Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: filtered-rules-${{ github.run_number }}
          path: |
            rules/**/*.list
          retention-days: 30
          if-no-files-found: warn

      - name: ðŸ“ Generate summary
        if: always()
        run: |
          {
            echo "## ðŸŽ¯ Domain Rules Filtering Results"
            echo ""
            echo "### ðŸ“Š Statistics"
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| Total Files | **${{ steps.verify.outputs.file_count }}** |"
            echo "| Mihomo Rules | **${{ steps.verify.outputs.mihomo_count }}** |"
            echo "| Surge Rules | **${{ steps.verify.outputs.surge_count }}** |"
            echo "| Loon Rules | **${{ steps.verify.outputs.loon_count }}** |"
            echo "| Non-IP Rules | **${{ steps.verify.outputs.non_ip_count }}** |"
            echo "| Total Size | **${{ steps.verify.outputs.total_size }}** |"
            echo "| Execution Time | $(date +'%Y-%m-%d %H:%M:%S UTC') |"
            echo "| Workflow Run | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |"
            echo ""
            echo "### ðŸ“ File Structure"
            echo ""
            echo "#### Mihomo Rules"
            echo "\`\`\`"
            find rules/mihomo -maxdepth 1 -name "*.list" -type f -exec sh -c 'echo "ðŸ“„ $(basename {}) - $(wc -l < {}) lines"' \; 2>/dev/null || echo "No files"
            echo "\`\`\`"
            echo ""
            echo "#### Surge Rules"
            echo "\`\`\`"
            find rules/surge -maxdepth 1 -name "*.list" -type f -exec sh -c 'echo "ðŸ“„ $(basename {}) - $(wc -l < {}) lines"' \; 2>/dev/null || echo "No files"
            echo "\`\`\`"
            echo ""
            echo "#### Loon Rules"
            echo "\`\`\`"
            find rules/loon -maxdepth 1 -name "*.list" -type f -exec sh -c 'echo "ðŸ“„ $(basename {}) - $(wc -l < {}) lines"' \; 2>/dev/null || echo "No files"
            echo "\`\`\`"
            echo ""
            echo "#### Non-IP Rules (Surge)"
            echo "\`\`\`"
            find rules/non_ip -name "*.list" -type f -exec sh -c 'echo "ðŸ“„ $(basename {}) - $(wc -l < {}) lines"' \; 2>/dev/null || echo "No files"
            echo "\`\`\`"
            echo ""
            echo "### ðŸ”— Artifacts"
            echo "Download the generated files from the [Artifacts section](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})."
          } >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”” Notify on failure
        if: failure()
        run: |
          echo "âŒ Workflow failed!"
          echo "ðŸ“‹ Debug information:"
          echo "---"
          ls -lR rules/ 2>/dev/null || echo "rules/ directory not found"
          echo "---"
          echo "Check the logs above for details."
