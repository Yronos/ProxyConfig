name: Filter Country Domain Rules

on:
  # æ¯3å¤©æ‰§è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´å‡Œæ™¨2ç‚¹ = åŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹ï¼‰
  schedule:
    - cron: "0 2 */3 * *"

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      threshold:
        description: "åŒºåŸŸå˜ä½“é˜ˆå€¼ï¼ˆé»˜è®¤5ï¼‰"
        required: false
        default: "5"
        type: string

  # Pushåˆ°mainåˆ†æ”¯æ—¶æ‰§è¡Œï¼ˆå¯é€‰ï¼‰
  push:
    branches:
      - main
    paths:
      - "auto/**"
      - ".github/workflows/filter-countries.yml"

jobs:
  filter-rules:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ï¼Œä¾¿äºæ¯”è¾ƒ

      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests urllib3

      # 4. æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      - name: â„¹ï¸ Environment info
        run: |
          echo "Python version: $(python --version)"
          echo "Pip version: $(pip --version)"
          echo "Working directory: $(pwd)"
          ls -la auto/

      # 5. è¿è¡Œè¿‡æ»¤è„šæœ¬
      - name: ğŸš€ Run filter_countries.py
        id: filter
        run: |
          cd auto
          python filter_countries.py
        continue-on-error: false

      # 6. éªŒè¯è¾“å‡º
      - name: âœ… Verify output files
        run: |
          if [ ! -d "auto/new" ]; then
            echo "âŒ Output directory not found"
            exit 1
          fi

          file_count=$(ls -1 auto/new/*.list 2>/dev/null | wc -l)
          if [ "$file_count" -eq 0 ]; then
            echo "âŒ No .list files generated"
            exit 1
          fi

          echo "âœ… Generated $file_count rule files"
          ls -lh auto/new/

      # 7. æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
      - name: ğŸ” Check for changes
        id: check_changes
        run: |
          if git diff --quiet auto/new/ auto/original/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ¨ Changes detected"
            git diff --stat auto/new/ auto/original/
          fi

      # 8. ç”Ÿæˆå˜æ›´æ‘˜è¦
      - name: ğŸ“Š Generate summary
        if: always()
        run: |
          {
            echo "## ğŸ¯ Domain Rule Filter Results"
            echo ""
            echo "### ğŸ“ˆ Statistics"
            echo "- **Execution Time**: $(date +'%Y-%m-%d %H:%M:%S UTC')"
            echo "- **Status**: ${{ steps.filter.outcome }}"
            echo "- **Files Generated**: $(ls -1 auto/new/*.list 2>/dev/null | wc -l)"
            echo "- **Changes Detected**: ${{ steps.check_changes.outputs.changed }}"
            echo ""
            echo "### ğŸ“ Output Files"
            echo "\`\`\`"
            ls -lh auto/new/ 2>/dev/null || echo "No files"
            echo "\`\`\`"
            echo ""
            if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
              echo "### ğŸ”„ Changes"
              echo "\`\`\`diff"
              git diff --stat auto/new/ auto/original/ 2>/dev/null || echo "Unable to show diff"
              echo "\`\`\`"
            fi
          } >> $GITHUB_STEP_SUMMARY

      # 9. æäº¤å˜åŒ–
      - name: ğŸ’¾ Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # æ·»åŠ æ–‡ä»¶
          git add auto/new/
          git add auto/original/

          # ç”Ÿæˆæäº¤ä¿¡æ¯
          commit_msg="ğŸ¤– Auto-update: Filter country domain rules

          Generated at: $(date +'%Y-%m-%d %H:%M:%S UTC')
          Workflow: ${{ github.workflow }}
          Run: ${{ github.run_number }}"

          git commit -m "$commit_msg"
          git push

      # 10. ä¸Šä¼ å¤„ç†ç»“æœï¼ˆä¿ç•™30å¤©ï¼‰
      - name: ğŸ“¤ Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: filtered-rules-${{ github.run_number }}
          path: |
            auto/new/
            auto/original/
          retention-days: 30
          if-no-files-found: warn

      # 11. å¤±è´¥æ—¶åˆ›å»ºIssue
      - name: ğŸš¨ Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `âŒ Country Domain Filter Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## âš ï¸ Workflow Execution Failed

            **Details:**
            - **Workflow**: ${context.workflow}
            - **Run Number**: [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - **Branch**: \`${context.ref}\`
            - **Commit**: [\`${context.sha.substring(0, 7)}\`](${context.payload.repository.html_url}/commit/${context.sha})
            - **Triggered by**: ${context.eventName}
            - **Time**: ${new Date().toISOString()}

            **Next Steps:**
            1. Check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId})
            2. Verify the script logic in \`auto/filter_countries.py\`
            3. Check if the source URLs are accessible

            ---
            *This issue was automatically created by GitHub Actions*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['automated', 'bug', 'workflow-failure']
            });
