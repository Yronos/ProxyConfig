name: Filter Country Domain Rules

on:
  schedule:
    - cron: "0 2 * * 0" # UTC å‘¨æ—¥ 02:00 = åŒ—äº¬å‘¨æ—¥ 10:00
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "auto/**"

jobs:
  filter-rules:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # èŽ·å–å®Œæ•´åŽ†å²ï¼ˆå¦‚æžœéœ€è¦ï¼‰

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip" # ç¼“å­˜pipä¾èµ–

      - name: ðŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests urllib3

      - name: ðŸ—‚ï¸ Ensure base directories exist
        run: |
          mkdir -p auto/new
          mkdir -p auto/original
          echo "âœ… Base directories created"
          ls -la auto/

      - name: ðŸš€ Run filter_countries.py
        id: run_script
        run: |
          cd auto
          python filter_countries.py
          exit_code=$?
          if [ $exit_code -ne 0 ]; then
            echo "âŒ Script failed with exit code $exit_code"
            exit $exit_code
          fi
          echo "âœ… Script completed successfully"

      - name: âœ… Verify output
        id: verify
        run: |
          if [ ! -d "auto/new" ]; then
            echo "âŒ Directory auto/new not found"
            exit 1
          fi

          # é€’å½’æŸ¥æ‰¾æ‰€æœ‰.listæ–‡ä»¶
          file_count=$(find auto/new -name "*.list" -type f | wc -l)

          if [ "$file_count" -eq 0 ]; then
            echo "âŒ No .list files generated"
            echo "ðŸ“‚ Directory structure:"
            tree auto/ || ls -lR auto/
            exit 1
          fi

          echo "âœ… Generated $file_count rule files"
          echo "file_count=$file_count" >> $GITHUB_OUTPUT

          # è®¡ç®—æ€»å¤§å°
          total_size=$(du -sh auto/new | cut -f1)
          echo "total_size=$total_size" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Show detailed file structure
        run: |
          echo "ðŸ“‹ Complete directory structure:"
          echo "-----------------------------------"

          # æ˜¾ç¤ºç›®å½•æ ‘ï¼ˆå¦‚æžœæœ‰treeå‘½ä»¤ï¼‰æˆ–ä½¿ç”¨find
          if command -v tree &> /dev/null; then
            tree -h auto/
          else
            echo "ðŸ“‚ auto/new/"
            find auto/new -type f -name "*.list" -exec sh -c 'echo "  â”œâ”€ {} ($(wc -l < {} | tr -d " ") lines, $(du -h {} | cut -f1))"' \;

            echo ""
            echo "ðŸ“‚ auto/original/"
            find auto/original -type f -name "*.list" -exec sh -c 'echo "  â”œâ”€ {} ($(wc -l < {} | tr -d " ") lines, $(du -h {} | cut -f1))"' \;
          fi

      - name: ðŸ’¾ Commit and push changes
        run: |
          # é…ç½® Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ˜¾ç¤ºå½“å‰çŠ¶æ€
          echo "ðŸ“‚ Git status before adding files:"
          git status

          # âœ… ä¿®å¤ï¼šé€’å½’æ·»åŠ æ‰€æœ‰å­ç›®å½•ä¸­çš„æ–‡ä»¶
          git add -f auto/new/
          git add -f auto/original/

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«æ·»åŠ 
          echo ""
          echo "ðŸ“‚ Files to be committed:"
          git diff --cached --name-only || echo "No files staged"

          # å¦‚æžœæœ‰å˜åŒ–å°±æäº¤
          if ! git diff --cached --quiet; then
            # èŽ·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
            changed_files=$(git diff --cached --name-only | wc -l)

            # åˆ›å»ºæäº¤ä¿¡æ¯
            cat > /tmp/commit_msg.txt << 'EOF'
          ðŸ¤– Auto-update: Filter domain rules

          ðŸ“… Generated: $(date +'%Y-%m-%d %H:%M:%S UTC')
          ðŸ“Š Statistics:
             â€¢ Rule files: ${{ steps.verify.outputs.file_count }}
             â€¢ Total size: ${{ steps.verify.outputs.total_size }}
             â€¢ Changed files: ${changed_files}

          ðŸ”„ Workflow: ${{ github.workflow }}
          ðŸƒ Run: #${{ github.run_number }}
          ðŸ”— Link: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF

            echo "ðŸ’¾ Committing changes..."
            git commit -F /tmp/commit_msg.txt

            echo "ðŸš€ Pushing to repository..."
            git push origin main

            echo "âœ… Successfully committed and pushed ${changed_files} files!"
          else
            echo "ðŸ“Œ No changes detected, skipping commit"
          fi

      - name: ðŸ“¤ Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: filtered-rules-${{ github.run_number }}
          path: |
            auto/new/**/*.list
            auto/original/**/*.list
          retention-days: 30
          if-no-files-found: warn

      - name: ðŸ“ Generate summary
        if: always()
        run: |
          {
            echo "## ðŸŽ¯ Domain Rules Filtering Results"
            echo ""
            echo "### ðŸ“Š Statistics"
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| Files Generated | **${{ steps.verify.outputs.file_count }}** |"
            echo "| Total Size | **${{ steps.verify.outputs.total_size }}** |"
            echo "| Execution Time | $(date +'%Y-%m-%d %H:%M:%S UTC') |"
            echo "| Workflow Run | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |"
            echo ""
            echo "### ðŸ“ File Structure"
            echo "\`\`\`"
            find auto/new -name "*.list" -type f -exec sh -c 'echo "ðŸ“„ {} - $(wc -l < {}) lines"' \; 2>/dev/null || echo "No files found"
            echo "\`\`\`"
            echo ""
            echo "### ðŸ”— Artifacts"
            echo "Download the generated files from the [Artifacts section](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})."
          } >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”” Notify on failure
        if: failure()
        run: |
          echo "âŒ Workflow failed!"
          echo "ðŸ“‹ Debug information:"
          echo "---"
          ls -lR auto/ 2>/dev/null || echo "auto/ directory not found"
          echo "---"
          echo "Check the logs above for details."
