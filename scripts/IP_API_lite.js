// 1. çŠ¶æ€ç æ£€æŸ¥
if ($response.statusCode != 200) {
  $done(null);
}

// 2. é»˜è®¤å€¼é…ç½®
const DEFAULTS = {
  city: "Unknown",
  isp: "Unknown ISP",
  timezone: "Unknown",
  flag: "ğŸ³ï¸",
};

// 3. ä¸‹æ ‡æ•°å­—æ˜ å°„ï¼ˆå­—ç¬¦ä¸²é”®ï¼‰
const SUBSCRIPT_MAP = {
  0: "â‚€",
  1: "â‚",
  2: "â‚‚",
  3: "â‚ƒ",
  4: "â‚„",
  5: "â‚…",
  6: "â‚†",
  7: "â‚‡",
  8: "â‚ˆ",
  9: "â‚‰",
  ".": ".",
};

// 4. å›½æ——æ˜ å°„è¡¨
const flags = new Map([
  ["AE", "ğŸ‡¦ğŸ‡ª"],
  ["AF", "ğŸ‡¦ğŸ‡«"],
  ["AI", "ğŸ‡¦ğŸ‡®"],
  ["AL", "ğŸ‡¦ğŸ‡±"],
  ["AQ", "ğŸ‡¦ğŸ‡¶"],
  ["AR", "ğŸ‡¦ğŸ‡·"],
  ["AT", "ğŸ‡¦ğŸ‡¹"],
  ["AU", "ğŸ‡¦ğŸ‡º"],
  ["AZ", "ğŸ‡¦ğŸ‡¿"],
  ["BD", "ğŸ‡§ğŸ‡©"],
  ["BE", "ğŸ‡§ğŸ‡ª"],
  ["BG", "ğŸ‡§ğŸ‡¬"],
  ["BW", "ğŸ‡§ğŸ‡¼"],
  ["BY", "ğŸ‡§ğŸ‡¾"],
  ["CA", "ğŸ‡¨ğŸ‡¦"],
  ["CF", "ğŸ‡¨ğŸ‡«"],
  ["CH", "ğŸ‡¨ğŸ‡­"],
  ["CK", "ğŸ‡¨ğŸ‡°"],
  ["CL", "ğŸ‡¨ğŸ‡±"],
  ["CM", "ğŸ‡¨ğŸ‡²"],
  ["CN", "ğŸ‡¨ğŸ‡³"],
  ["CO", "ğŸ‡¨ğŸ‡´"],
  ["CP", "ğŸ‡¨ğŸ‡µ"],
  ["CR", "ğŸ‡¨ğŸ‡·"],
  ["CU", "ğŸ‡¨ğŸ‡º"],
  ["CV", "ğŸ‡¨ğŸ‡»"],
  ["CW", "ğŸ‡¨ğŸ‡¼"],
  ["CX", "ğŸ‡¨ğŸ‡½"],
  ["CY", "ğŸ‡¨ğŸ‡¾"],
  ["CZ", "ğŸ‡¨ğŸ‡¿"],
  ["DE", "ğŸ‡©ğŸ‡ª"],
  ["DG", "ğŸ‡©ğŸ‡¬"],
  ["DJ", "ğŸ‡©ğŸ‡¯"],
  ["DK", "ğŸ‡©ğŸ‡°"],
  ["DM", "ğŸ‡©ğŸ‡²"],
  ["DO", "ğŸ‡©ğŸ‡´"],
  ["DZ", "ğŸ‡©ğŸ‡¿"],
  ["EA", "ğŸ‡ªğŸ‡¦"],
  ["EC", "ğŸ‡ªğŸ‡¨"],
  ["EE", "ğŸ‡ªğŸ‡ª"],
  ["EG", "ğŸ‡ªğŸ‡¬"],
  ["EH", "ğŸ‡ªğŸ‡­"],
  ["ER", "ğŸ‡ªğŸ‡·"],
  ["ES", "ğŸ‡ªğŸ‡¸"],
  ["ET", "ğŸ‡ªğŸ‡¹"],
  ["EU", "ğŸ‡ªğŸ‡º"],
  ["FI", "ğŸ‡«ğŸ‡®"],
  ["FJ", "ğŸ‡«ğŸ‡¯"],
  ["FK", "ğŸ‡«ğŸ‡°"],
  ["FM", "ğŸ‡«ğŸ‡²"],
  ["FO", "ğŸ‡«ğŸ‡´"],
  ["FR", "ğŸ‡«ğŸ‡·"],
  ["GA", "ğŸ‡¬ğŸ‡¦"],
  ["GB", "ğŸ‡¬ğŸ‡§"],
  ["GD", "ğŸ‡¬ğŸ‡©"],
  ["GE", "ğŸ‡¬ğŸ‡ª"],
  ["GF", "ğŸ‡¬ğŸ‡«"],
  ["GG", "ğŸ‡¬ğŸ‡¬"],
  ["GH", "ğŸ‡¬ğŸ‡­"],
  ["GI", "ğŸ‡¬ğŸ‡®"],
  ["GL", "ğŸ‡¬ğŸ‡±"],
  ["GM", "ğŸ‡¬ğŸ‡²"],
  ["GN", "ğŸ‡¬ğŸ‡³"],
  ["GP", "ğŸ‡¬ğŸ‡µ"],
  ["GQ", "ğŸ‡¬ğŸ‡¶"],
  ["GR", "ğŸ‡¬ğŸ‡·"],
  ["GT", "ğŸ‡¬ğŸ‡¹"],
  ["GU", "ğŸ‡¬ğŸ‡º"],
  ["GW", "ğŸ‡¬ğŸ‡¼"],
  ["GY", "ğŸ‡¬ğŸ‡¾"],
  ["HK", "ğŸ‡­ğŸ‡°"],
  ["HN", "ğŸ‡­ğŸ‡³"],
  ["HR", "ğŸ‡­ğŸ‡·"],
  ["HT", "ğŸ‡­ğŸ‡¹"],
  ["HU", "ğŸ‡­ğŸ‡º"],
  ["ID", "ğŸ‡®ğŸ‡©"],
  ["IE", "ğŸ‡®ğŸ‡ª"],
  ["IL", "ğŸ‡®ğŸ‡±"],
  ["IM", "ğŸ‡®ğŸ‡²"],
  ["IN", "ğŸ‡®ğŸ‡³"],
  ["IQ", "ğŸ‡®ğŸ‡¶"],
  ["IR", "ğŸ‡®ğŸ‡·"],
  ["IS", "ğŸ‡®ğŸ‡¸"],
  ["IT", "ğŸ‡®ğŸ‡¹"],
  ["JE", "ğŸ‡¯ğŸ‡ª"],
  ["JM", "ğŸ‡¯ğŸ‡²"],
  ["JO", "ğŸ‡¯ğŸ‡´"],
  ["JP", "ğŸ‡¯ğŸ‡µ"],
  ["KE", "ğŸ‡°ğŸ‡ª"],
  ["KG", "ğŸ‡°ğŸ‡¬"],
  ["KH", "ğŸ‡°ğŸ‡­"],
  ["KI", "ğŸ‡°ğŸ‡®"],
  ["KM", "ğŸ‡°ğŸ‡²"],
  ["KN", "ğŸ‡°ğŸ‡³"],
  ["KP", "ğŸ‡°ğŸ‡µ"],
  ["KR", "ğŸ‡°ğŸ‡·"],
  ["KW", "ğŸ‡°ğŸ‡¼"],
  ["KY", "ğŸ‡°ğŸ‡¾"],
  ["KZ", "ğŸ‡°ğŸ‡¿"],
  ["LA", "ğŸ‡±ğŸ‡¦"],
  ["LB", "ğŸ‡±ğŸ‡§"],
  ["LC", "ğŸ‡±ğŸ‡¨"],
  ["LI", "ğŸ‡±ğŸ‡®"],
  ["LK", "ğŸ‡±ğŸ‡°"],
  ["LR", "ğŸ‡±ğŸ‡·"],
  ["LS", "ğŸ‡±ğŸ‡¸"],
  ["LT", "ğŸ‡±ğŸ‡¹"],
  ["LU", "ğŸ‡±ğŸ‡º"],
  ["LV", "ğŸ‡±ğŸ‡»"],
  ["LY", "ğŸ‡±ğŸ‡¾"],
  ["MA", "ğŸ‡²ğŸ‡¦"],
  ["MC", "ğŸ‡²ğŸ‡¨"],
  ["MD", "ğŸ‡²ğŸ‡©"],
  ["ME", "ğŸ‡²ğŸ‡ª"],
  ["MG", "ğŸ‡²ğŸ‡¬"],
  ["MH", "ğŸ‡²ğŸ‡­"],
  ["MK", "ğŸ‡²ğŸ‡°"],
  ["ML", "ğŸ‡²ğŸ‡±"],
  ["MM", "ğŸ‡²ğŸ‡²"],
  ["MN", "ğŸ‡²ğŸ‡³"],
  ["MO", "ğŸ‡²ğŸ‡´"],
  ["MP", "ğŸ‡²ğŸ‡µ"],
  ["MQ", "ğŸ‡²ğŸ‡¶"],
  ["MR", "ğŸ‡²ğŸ‡·"],
  ["MS", "ğŸ‡²ğŸ‡¸"],
  ["MT", "ğŸ‡²ğŸ‡¹"],
  ["MU", "ğŸ‡²ğŸ‡º"],
  ["MV", "ğŸ‡²ğŸ‡»"],
  ["MW", "ğŸ‡²ğŸ‡¼"],
  ["MX", "ğŸ‡²ğŸ‡½"],
  ["MY", "ğŸ‡²ğŸ‡¾"],
  ["MZ", "ğŸ‡²ğŸ‡¿"],
  ["NA", "ğŸ‡³ğŸ‡¦"],
  ["NC", "ğŸ‡³ğŸ‡¨"],
  ["NE", "ğŸ‡³ğŸ‡ª"],
  ["NF", "ğŸ‡³ğŸ‡«"],
  ["NG", "ğŸ‡³ğŸ‡¬"],
  ["NI", "ğŸ‡³ğŸ‡®"],
  ["NL", "ğŸ‡³ğŸ‡±"],
  ["NO", "ğŸ‡³ğŸ‡´"],
  ["NP", "ğŸ‡³ğŸ‡µ"],
  ["NR", "ğŸ‡³ğŸ‡·"],
  ["NU", "ğŸ‡³ğŸ‡º"],
  ["NZ", "ğŸ‡³ğŸ‡¿"],
  ["OM", "ğŸ‡´ğŸ‡²"],
  ["PA", "ğŸ‡µğŸ‡¦"],
  ["PE", "ğŸ‡µğŸ‡ª"],
  ["PF", "ğŸ‡µğŸ‡«"],
  ["PG", "ğŸ‡µğŸ‡¬"],
  ["PH", "ğŸ‡µğŸ‡­"],
  ["PK", "ğŸ‡µğŸ‡°"],
  ["PL", "ğŸ‡µğŸ‡±"],
  ["PM", "ğŸ‡µğŸ‡²"],
  ["PN", "ğŸ‡µğŸ‡³"],
  ["PR", "ğŸ‡µğŸ‡·"],
  ["PS", "ğŸ‡µğŸ‡¸"],
  ["PT", "ğŸ‡µğŸ‡¹"],
  ["PW", "ğŸ‡µğŸ‡¼"],
  ["PY", "ğŸ‡µğŸ‡¾"],
  ["QA", "ğŸ‡¶ğŸ‡¦"],
  ["RE", "ğŸ‡·ğŸ‡ª"],
  ["RO", "ğŸ‡·ğŸ‡´"],
  ["RS", "ğŸ‡·ğŸ‡¸"],
  ["RU", "ğŸ‡·ğŸ‡º"],
  ["RW", "ğŸ‡·ğŸ‡¼"],
  ["SA", "ğŸ‡¸ğŸ‡¦"],
  ["SB", "ğŸ‡¸ğŸ‡§"],
  ["SC", "ğŸ‡¸ğŸ‡¨"],
  ["SD", "ğŸ‡¸ğŸ‡©"],
  ["SE", "ğŸ‡¸ğŸ‡ª"],
  ["SG", "ğŸ‡¸ğŸ‡¬"],
  ["SH", "ğŸ‡¸ğŸ‡­"],
  ["SI", "ğŸ‡¸ğŸ‡®"],
  ["SK", "ğŸ‡¸ğŸ‡°"],
  ["SL", "ğŸ‡¸ğŸ‡±"],
  ["SM", "ğŸ‡¸ğŸ‡²"],
  ["SN", "ğŸ‡¸ğŸ‡³"],
  ["SO", "ğŸ‡¸ğŸ‡´"],
  ["SR", "ğŸ‡¸ğŸ‡·"],
  ["SS", "ğŸ‡¸ğŸ‡¸"],
  ["ST", "ğŸ‡¸ğŸ‡¹"],
  ["SV", "ğŸ‡¸ğŸ‡»"],
  ["SX", "ğŸ‡¸ğŸ‡½"],
  ["SY", "ğŸ‡¸ğŸ‡¾"],
  ["SZ", "ğŸ‡¸ğŸ‡¿"],
  ["TC", "ğŸ‡¹ğŸ‡¨"],
  ["TD", "ğŸ‡¹ğŸ‡©"],
  ["TF", "ğŸ‡¹ğŸ‡«"],
  ["TG", "ğŸ‡¹ğŸ‡¬"],
  ["TH", "ğŸ‡¹ğŸ‡­"],
  ["TJ", "ğŸ‡¹ğŸ‡¯"],
  ["TK", "ğŸ‡¹ğŸ‡°"],
  ["TL", "ğŸ‡¹ğŸ‡±"],
  ["TM", "ğŸ‡¹ğŸ‡²"],
  ["TN", "ğŸ‡¹ğŸ‡³"],
  ["TO", "ğŸ‡¹ğŸ‡´"],
  ["TR", "ğŸ‡¹ğŸ‡·"],
  ["TT", "ğŸ‡¹ğŸ‡¹"],
  ["TV", "ğŸ‡¹ğŸ‡»"],
  ["TW", "ğŸ‡¨ğŸ‡³"],
  ["TZ", "ğŸ‡¹ğŸ‡¿"],
  ["UA", "ğŸ‡ºğŸ‡¦"],
  ["UG", "ğŸ‡ºğŸ‡¬"],
  ["UK", "ğŸ‡¬ğŸ‡§"],
  ["UM", "ğŸ‡ºğŸ‡²"],
  ["US", "ğŸ‡ºğŸ‡¸"],
  ["UY", "ğŸ‡ºğŸ‡¾"],
  ["UZ", "ğŸ‡ºğŸ‡¿"],
  ["VA", "ğŸ‡»ğŸ‡¦"],
  ["VC", "ğŸ‡»ğŸ‡¨"],
  ["VE", "ğŸ‡»ğŸ‡ª"],
  ["VG", "ğŸ‡»ğŸ‡¬"],
  ["VI", "ğŸ‡»ğŸ‡®"],
  ["VN", "ğŸ‡»ğŸ‡³"],
  ["VU", "ğŸ‡»ğŸ‡º"],
  ["WF", "ğŸ‡¼ğŸ‡«"],
  ["WS", "ğŸ‡¼ğŸ‡¸"],
  ["YE", "ğŸ‡¾ğŸ‡ª"],
  ["YT", "ğŸ‡¾ğŸ‡¹"],
  ["ZA", "ğŸ‡¿ğŸ‡¦"],
  ["ZM", "ğŸ‡¿ğŸ‡²"],
  ["ZW", "ğŸ‡¿ğŸ‡¼"],
]);

// 5. å·¥å…·å‡½æ•°ï¼šIP è½¬ä¸‹æ ‡æ•°å­—
function toSubscript(str) {
  if (!str) return "";
  return str
    .toString()
    .split("")
    .map((c) => SUBSCRIPT_MAP[c] || c)
    .join("");
}

// 6. è§£æå“åº”æ•°æ®
var body = $response.body;
var obj = JSON.parse(body);

// 7. æå–æ•°æ®
var country = obj.country || "Unknown";
var countryCode = obj.countryCode || "";
var city = obj.city || DEFAULTS.city;
var query = obj.query || "0.0.0.0";
var isp = obj.org || obj.as || obj.isp || DEFAULTS.isp;
var timezone = obj.timezone || DEFAULTS.timezone;

// 8. è·å–å›½æ——
var flag = flags.get(countryCode) || DEFAULTS.flag;

// 9. æ ¼å¼åŒ–è¾“å‡º
var title = flag + " " + city + " " + toSubscript(query);
var subtitle = isp + " | " + timezone;
var ip = query;
var description = country + "\n" + city + "\n" + isp + "\n" + timezone;

// 10. è¿”å›ç»“æœï¼ˆå¿…é¡»åŒ…å« title, subtitle, ip, descriptionï¼‰
$done({ title, subtitle, ip, description });
